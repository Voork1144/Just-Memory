name: Publish Qdrant Packages

on:
  workflow_dispatch:
    inputs:
      qdrant_version:
        description: 'Qdrant version to package (e.g. 1.16.3)'
        required: true
        default: '1.16.3'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        include:
          - platform: linux-x64
            archive: qdrant-x86_64-unknown-linux-gnu.tar.gz
            format: tar
          - platform: linux-arm64
            archive: qdrant-aarch64-unknown-linux-musl.tar.gz
            format: tar
          - platform: darwin-x64
            archive: qdrant-x86_64-apple-darwin.tar.gz
            format: tar
          - platform: darwin-arm64
            archive: qdrant-aarch64-apple-darwin.tar.gz
            format: tar
          - platform: win32-x64
            archive: qdrant-x86_64-pc-windows-msvc.zip
            format: zip
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Download Qdrant binary
        run: |
          curl -L -o archive "https://github.com/qdrant/qdrant/releases/download/v${{ inputs.qdrant_version }}/${{ matrix.archive }}"

      - name: Extract binary
        run: |
          cd packages/qdrant-${{ matrix.platform }}
          mkdir -p bin
          if [ "${{ matrix.format }}" = "zip" ]; then
            unzip -o ../../archive -d bin/
          else
            tar xzf ../../archive -C bin/
          fi

      - name: Update version in package.json
        run: |
          cd packages/qdrant-${{ matrix.platform }}
          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('package.json','utf8'));
            pkg.version = '${{ inputs.qdrant_version }}';
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Verify binary
        run: |
          ls -la packages/qdrant-${{ matrix.platform }}/bin/
          file packages/qdrant-${{ matrix.platform }}/bin/qdrant* || true

      - name: Publish
        run: |
          cd packages/qdrant-${{ matrix.platform }}
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
